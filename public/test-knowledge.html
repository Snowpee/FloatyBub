<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†åº“é›†æˆæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª çŸ¥è¯†åº“é›†æˆæµ‹è¯•</h1>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•çŸ¥è¯†åº“æ£€ç´¢å’Œæç¤ºè¯æ³¨å…¥åŠŸèƒ½çš„å®Œæ•´æµç¨‹ã€‚</p>
        
        <div class="test-controls">
            <button id="runTest" class="button">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <button id="clearLogs" class="button">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
            <button id="goBack" class="button">â† è¿”å›åº”ç”¨</button>
        </div>
        
        <div id="status" class="status info">
            ğŸ“‹ å‡†å¤‡è¿è¡Œæµ‹è¯•...
        </div>
        
        <div id="logs" class="log-area">
            ç­‰å¾…æµ‹è¯•å¼€å§‹...
        </div>
    </div>

    <script type="module">
        // é‡å†™console.logæ¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        const originalLog = console.log;
        const originalError = console.error;
        const logsElement = document.getElementById('logs');
        const statusElement = document.getElementById('status');
        
        function addLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logsElement.textContent += logMessage + '\n';
            logsElement.scrollTop = logsElement.scrollHeight;
            originalLog(logMessage);
        }
        
        function setStatus(message, type = 'info') {
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }
        
        console.log = (...args) => {
            addLog(args.join(' '), 'log');
        };
        
        console.error = (...args) => {
            addLog('âŒ ' + args.join(' '), 'error');
            originalError(...args);
        };
        
        // æµ‹è¯•å‡½æ•°
        async function runKnowledgeTest() {
            const runButton = document.getElementById('runTest');
            runButton.disabled = true;
            runButton.textContent = 'ğŸ”„ æµ‹è¯•è¿›è¡Œä¸­...';
            
            setStatus('ğŸ”„ æµ‹è¯•è¿›è¡Œä¸­...', 'info');
            logsElement.textContent = '';
            
            try {
                // åŠ¨æ€å¯¼å…¥æœåŠ¡
                const { KnowledgeService } = await import('/src/services/knowledgeService.js');
                const { ChatEnhancementService } = await import('/src/services/chatEnhancementService.js');
                
                console.log('ğŸ§ª å¼€å§‹çŸ¥è¯†åº“é›†æˆæµ‹è¯•...');
                
                // æµ‹è¯•æ•°æ®
                const testKnowledgeBase = {
                    name: 'æµ‹è¯•çŸ¥è¯†åº“',
                    description: 'ç”¨äºæµ‹è¯•çŸ¥è¯†åº“æ£€ç´¢åŠŸèƒ½çš„æµ‹è¯•æ•°æ®'
                };
                
                const testKnowledgeEntries = [
                    {
                        name: 'JavaScriptåŸºç¡€',
                        explanation: 'JavaScriptæ˜¯ä¸€ç§åŠ¨æ€ç¼–ç¨‹è¯­è¨€ï¼Œä¸»è¦ç”¨äºç½‘é¡µå¼€å‘ã€‚å®ƒæ”¯æŒé¢å‘å¯¹è±¡ã€å‡½æ•°å¼å’Œè¿‡ç¨‹å¼ç¼–ç¨‹èŒƒå¼ã€‚',
                        keywords: ['javascript', 'ç¼–ç¨‹', 'å‰ç«¯']
                    },
                    {
                        name: 'Reactæ¡†æ¶',
                        explanation: 'Reactæ˜¯Facebookå¼€å‘çš„ç”¨äºæ„å»ºç”¨æˆ·ç•Œé¢çš„JavaScriptåº“ã€‚å®ƒé‡‡ç”¨ç»„ä»¶åŒ–æ¶æ„ï¼Œä½¿ç”¨è™šæ‹ŸDOMæé«˜æ€§èƒ½ã€‚',
                        keywords: ['react', 'javascript', 'å‰ç«¯', 'æ¡†æ¶']
                    },
                    {
                        name: 'æ•°æ®åº“è®¾è®¡',
                        explanation: 'æ•°æ®åº“è®¾è®¡æ˜¯æŒ‡æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾è®¡æ•°æ®åº“ç»“æ„çš„è¿‡ç¨‹ã€‚åŒ…æ‹¬å®ä½“å…³ç³»å»ºæ¨¡ã€è¡¨ç»“æ„è®¾è®¡ã€ç´¢å¼•ä¼˜åŒ–ç­‰ã€‚',
                        keywords: ['æ•°æ®åº“', 'è®¾è®¡', 'åç«¯']
                    }
                ];
                
                const testRoleId = 'code-expert';
                const testUserMessage = 'Reactç»„ä»¶å¦‚ä½•ä¼˜åŒ–æ€§èƒ½ï¼Ÿ';
                
                // 1. åˆ›å»ºæµ‹è¯•çŸ¥è¯†åº“
                console.log('\nğŸ“š æ­¥éª¤1: åˆ›å»ºæµ‹è¯•çŸ¥è¯†åº“');
                const knowledgeBase = await KnowledgeService.createKnowledgeBase(testKnowledgeBase);
                console.log('âœ… çŸ¥è¯†åº“åˆ›å»ºæˆåŠŸ:', knowledgeBase.id);
                
                // 2. æ·»åŠ çŸ¥è¯†æ¡ç›®
                console.log('\nğŸ“ æ­¥éª¤2: æ·»åŠ çŸ¥è¯†æ¡ç›®');
                const entries = [];
                for (const entryData of testKnowledgeEntries) {
                    const entry = await KnowledgeService.createKnowledgeEntry({
                        name: entryData.name,
                        keywords: entryData.keywords,
                        explanation: entryData.explanation,
                        knowledge_base_id: knowledgeBase.id
                    });
                    entries.push(entry);
                    console.log(`âœ… çŸ¥è¯†æ¡ç›®åˆ›å»ºæˆåŠŸ: ${entry?.id || entry?.name || 'undefined'}`);
                }
                
                // 3. å°†çŸ¥è¯†åº“å…³è”åˆ°è§’è‰²
                console.log('\nğŸ”— æ­¥éª¤3: å…³è”çŸ¥è¯†åº“åˆ°è§’è‰²');
                await KnowledgeService.setRoleKnowledgeBase(testRoleId, knowledgeBase.id);
                console.log(`âœ… è§’è‰² ${testRoleId} å·²å…³è”çŸ¥è¯†åº“ ${knowledgeBase.id}`);
                
                // 4. éªŒè¯è§’è‰²çŸ¥è¯†åº“å…³è”
                console.log('\nğŸ” æ­¥éª¤4: éªŒè¯è§’è‰²çŸ¥è¯†åº“å…³è”');
                const associatedKnowledgeBase = await KnowledgeService.getRoleKnowledgeBase(testRoleId);
                if (associatedKnowledgeBase && associatedKnowledgeBase.id === knowledgeBase.id) {
                    console.log('âœ… è§’è‰²çŸ¥è¯†åº“å…³è”éªŒè¯æˆåŠŸ');
                } else {
                    console.error('âŒ è§’è‰²çŸ¥è¯†åº“å…³è”éªŒè¯å¤±è´¥');
                    throw new Error('è§’è‰²çŸ¥è¯†åº“å…³è”éªŒè¯å¤±è´¥');
                }
                
                // 5. æµ‹è¯•çŸ¥è¯†åº“å¢å¼ºåŠŸèƒ½
                console.log('\nğŸš€ æ­¥éª¤5: æµ‹è¯•çŸ¥è¯†åº“å¢å¼ºåŠŸèƒ½');
                const enhancedContext = await ChatEnhancementService.enhanceChatContext(
                    testUserMessage,
                    knowledgeBase.id,
                    {
                        maxResults: 3,
                        minRelevanceScore: 0.1,
                        includeDebugInfo: true
                    }
                );
                
                console.log('ğŸ“Š å¢å¼ºç»“æœ:');
                console.log('- æå–çš„å…³é”®è¯:', enhancedContext.extractedKeywords);
                
                // è·å–æ‰€æœ‰çŸ¥è¯†æ¡ç›®
                const allEntries = enhancedContext.knowledgeResults.flatMap(result => result.entries);
                console.log('- æ£€ç´¢åˆ°çš„çŸ¥è¯†æ¡ç›®æ•°é‡:', allEntries.length);
                
                if (allEntries.length > 0) {
                    console.log('\nğŸ“‹ ç›¸å…³çŸ¥è¯†æ¡ç›®:');
                    allEntries.forEach((entry, index) => {
                        console.log(`  ${index + 1}. ${entry.name}`);
                    });
                    
                    // æ˜¾ç¤ºåŒ¹é…çš„å…³é”®è¯
                    const allMatchedKeywords = enhancedContext.knowledgeResults.flatMap(result => result.matchedKeywords);
                    if (allMatchedKeywords.length > 0) {
                        console.log('- åŒ¹é…çš„å…³é”®è¯:', allMatchedKeywords.join(', '));
                    }
                }
                
                // 6. æµ‹è¯•æç¤ºè¯æ³¨å…¥
                console.log('\nğŸ’‰ æ­¥éª¤6: æµ‹è¯•æç¤ºè¯æ³¨å…¥');
                const baseSystemPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¼–ç¨‹ä¸“å®¶ã€‚';
                const enhancedPrompt = ChatEnhancementService.injectKnowledgeContext(
                    baseSystemPrompt,
                    enhancedContext
                );
                
                console.log('\nğŸ“ åŸå§‹ç³»ç»Ÿæç¤ºè¯:');
                console.log(baseSystemPrompt);
                console.log('\nğŸ“ å¢å¼ºåçš„ç³»ç»Ÿæç¤ºè¯:');
                console.log(enhancedPrompt);
                
                // 7. è·å–è°ƒè¯•ä¿¡æ¯
                console.log('\nğŸ”§ æ­¥éª¤7: è·å–è°ƒè¯•ä¿¡æ¯');
                const debugInfo = ChatEnhancementService.getDebugInfo(enhancedContext);
                console.log('è°ƒè¯•ä¿¡æ¯:', debugInfo);
                
                console.log('\nğŸ‰ çŸ¥è¯†åº“é›†æˆæµ‹è¯•å®Œæˆï¼');
                
                // æ¸…ç†æµ‹è¯•æ•°æ®
                console.log('\nğŸ§¹ æ¸…ç†æµ‹è¯•æ•°æ®...');
                await KnowledgeService.setRoleKnowledgeBase(testRoleId, null);
                await KnowledgeService.deleteKnowledgeBase(knowledgeBase.id);
                console.log('âœ… æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ');
                
                setStatus('ğŸ‰ æµ‹è¯•æˆåŠŸå®Œæˆï¼', 'success');
                
            } catch (error) {
                console.error('âŒ æµ‹è¯•å¤±è´¥:', error.message);
                console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
                setStatus('âŒ æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            } finally {
                runButton.disabled = false;
                runButton.textContent = 'ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•';
            }
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('runTest').addEventListener('click', runKnowledgeTest);
        
        document.getElementById('clearLogs').addEventListener('click', () => {
            logsElement.textContent = 'æ—¥å¿—å·²æ¸…ç©º...';
            setStatus('ğŸ“‹ å‡†å¤‡è¿è¡Œæµ‹è¯•...', 'info');
        });
        
        document.getElementById('goBack').addEventListener('click', () => {
            window.location.href = '/';
        });
        
        // é¡µé¢åŠ è½½å®Œæˆæç¤º
        addLog('ğŸ“‹ æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆï¼Œç‚¹å‡»"è¿è¡Œå®Œæ•´æµ‹è¯•"å¼€å§‹æµ‹è¯•');
    </script>
</body>
</html>