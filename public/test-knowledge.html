<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知识库集成测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 知识库集成测试</h1>
        <p>这个页面用于测试知识库检索和提示词注入功能的完整流程。</p>
        
        <div class="test-controls">
            <button id="runTest" class="button">🚀 运行完整测试</button>
            <button id="clearLogs" class="button">🧹 清空日志</button>
            <button id="goBack" class="button">← 返回应用</button>
        </div>
        
        <div id="status" class="status info">
            📋 准备运行测试...
        </div>
        
        <div id="logs" class="log-area">
            等待测试开始...
        </div>
    </div>

    <script type="module">
        // 重写console.log来显示在页面上
        const originalLog = console.log;
        const originalError = console.error;
        const logsElement = document.getElementById('logs');
        const statusElement = document.getElementById('status');
        
        function addLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logsElement.textContent += logMessage + '\n';
            logsElement.scrollTop = logsElement.scrollHeight;
            originalLog(logMessage);
        }
        
        function setStatus(message, type = 'info') {
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }
        
        console.log = (...args) => {
            addLog(args.join(' '), 'log');
        };
        
        console.error = (...args) => {
            addLog('❌ ' + args.join(' '), 'error');
            originalError(...args);
        };
        
        // 测试函数
        async function runKnowledgeTest() {
            const runButton = document.getElementById('runTest');
            runButton.disabled = true;
            runButton.textContent = '🔄 测试进行中...';
            
            setStatus('🔄 测试进行中...', 'info');
            logsElement.textContent = '';
            
            try {
                // 动态导入服务
                const { KnowledgeService } = await import('/src/services/knowledgeService.js');
                const { ChatEnhancementService } = await import('/src/services/chatEnhancementService.js');
                
                console.log('🧪 开始知识库集成测试...');
                
                // 测试数据
                const testKnowledgeBase = {
                    name: '测试知识库',
                    description: '用于测试知识库检索功能的测试数据'
                };
                
                const testKnowledgeEntries = [
                    {
                        name: 'JavaScript基础',
                        explanation: 'JavaScript是一种动态编程语言，主要用于网页开发。它支持面向对象、函数式和过程式编程范式。',
                        keywords: ['javascript', '编程', '前端']
                    },
                    {
                        name: 'React框架',
                        explanation: 'React是Facebook开发的用于构建用户界面的JavaScript库。它采用组件化架构，使用虚拟DOM提高性能。',
                        keywords: ['react', 'javascript', '前端', '框架']
                    },
                    {
                        name: '数据库设计',
                        explanation: '数据库设计是指根据业务需求设计数据库结构的过程。包括实体关系建模、表结构设计、索引优化等。',
                        keywords: ['数据库', '设计', '后端']
                    }
                ];
                
                const testRoleId = 'code-expert';
                const testUserMessage = 'React组件如何优化性能？';
                
                // 1. 创建测试知识库
                console.log('\n📚 步骤1: 创建测试知识库');
                const knowledgeBase = await KnowledgeService.createKnowledgeBase(testKnowledgeBase);
                console.log('✅ 知识库创建成功:', knowledgeBase.id);
                
                // 2. 添加知识条目
                console.log('\n📝 步骤2: 添加知识条目');
                const entries = [];
                for (const entryData of testKnowledgeEntries) {
                    const entry = await KnowledgeService.createKnowledgeEntry({
                        name: entryData.name,
                        keywords: entryData.keywords,
                        explanation: entryData.explanation,
                        knowledge_base_id: knowledgeBase.id
                    });
                    entries.push(entry);
                    console.log(`✅ 知识条目创建成功: ${entry?.id || entry?.name || 'undefined'}`);
                }
                
                // 3. 将知识库关联到角色
                console.log('\n🔗 步骤3: 关联知识库到角色');
                await KnowledgeService.setRoleKnowledgeBase(testRoleId, knowledgeBase.id);
                console.log(`✅ 角色 ${testRoleId} 已关联知识库 ${knowledgeBase.id}`);
                
                // 4. 验证角色知识库关联
                console.log('\n🔍 步骤4: 验证角色知识库关联');
                const associatedKnowledgeBase = await KnowledgeService.getRoleKnowledgeBase(testRoleId);
                if (associatedKnowledgeBase && associatedKnowledgeBase.id === knowledgeBase.id) {
                    console.log('✅ 角色知识库关联验证成功');
                } else {
                    console.error('❌ 角色知识库关联验证失败');
                    throw new Error('角色知识库关联验证失败');
                }
                
                // 5. 测试知识库增强功能
                console.log('\n🚀 步骤5: 测试知识库增强功能');
                const enhancedContext = await ChatEnhancementService.enhanceChatContext(
                    testUserMessage,
                    knowledgeBase.id,
                    {
                        maxResults: 3,
                        minRelevanceScore: 0.1,
                        includeDebugInfo: true
                    }
                );
                
                console.log('📊 增强结果:');
                console.log('- 提取的关键词:', enhancedContext.extractedKeywords);
                
                // 获取所有知识条目
                const allEntries = enhancedContext.knowledgeResults.flatMap(result => result.entries);
                console.log('- 检索到的知识条目数量:', allEntries.length);
                
                if (allEntries.length > 0) {
                    console.log('\n📋 相关知识条目:');
                    allEntries.forEach((entry, index) => {
                        console.log(`  ${index + 1}. ${entry.name}`);
                    });
                    
                    // 显示匹配的关键词
                    const allMatchedKeywords = enhancedContext.knowledgeResults.flatMap(result => result.matchedKeywords);
                    if (allMatchedKeywords.length > 0) {
                        console.log('- 匹配的关键词:', allMatchedKeywords.join(', '));
                    }
                }
                
                // 6. 测试提示词注入
                console.log('\n💉 步骤6: 测试提示词注入');
                const baseSystemPrompt = '你是一个专业的编程专家。';
                const enhancedPrompt = ChatEnhancementService.injectKnowledgeContext(
                    baseSystemPrompt,
                    enhancedContext
                );
                
                console.log('\n📝 原始系统提示词:');
                console.log(baseSystemPrompt);
                console.log('\n📝 增强后的系统提示词:');
                console.log(enhancedPrompt);
                
                // 7. 获取调试信息
                console.log('\n🔧 步骤7: 获取调试信息');
                const debugInfo = ChatEnhancementService.getDebugInfo(enhancedContext);
                console.log('调试信息:', debugInfo);
                
                console.log('\n🎉 知识库集成测试完成！');
                
                // 清理测试数据
                console.log('\n🧹 清理测试数据...');
                await KnowledgeService.setRoleKnowledgeBase(testRoleId, null);
                await KnowledgeService.deleteKnowledgeBase(knowledgeBase.id);
                console.log('✅ 测试数据清理完成');
                
                setStatus('🎉 测试成功完成！', 'success');
                
            } catch (error) {
                console.error('❌ 测试失败:', error.message);
                console.error('错误详情:', error.stack);
                setStatus('❌ 测试失败: ' + error.message, 'error');
            } finally {
                runButton.disabled = false;
                runButton.textContent = '🚀 运行完整测试';
            }
        }
        
        // 事件监听器
        document.getElementById('runTest').addEventListener('click', runKnowledgeTest);
        
        document.getElementById('clearLogs').addEventListener('click', () => {
            logsElement.textContent = '日志已清空...';
            setStatus('📋 准备运行测试...', 'info');
        });
        
        document.getElementById('goBack').addEventListener('click', () => {
            window.location.href = '/';
        });
        
        // 页面加载完成提示
        addLog('📋 测试页面加载完成，点击"运行完整测试"开始测试');
    </script>
</body>
</html>