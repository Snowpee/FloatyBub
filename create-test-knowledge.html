<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºæµ‹è¯•çŸ¥è¯†åº“</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            background: #28a745;
        }
        .success:hover {
            background: #1e7e34;
        }
    </style>
</head>
<body>
    <h1>åˆ›å»ºæµ‹è¯•çŸ¥è¯†åº“</h1>
    
    <div class="section">
        <h2>1. åˆ›å»ºæµ‹è¯•çŸ¥è¯†æ¡ç›®</h2>
        <button onclick="createTestEntries()">åˆ›å»ºæµ‹è¯•æ¡ç›®</button>
        <div id="createResult" class="log"></div>
    </div>
    
    <div class="section">
        <h2>2. éªŒè¯çŸ¥è¯†åº“å†…å®¹</h2>
        <button onclick="verifyKnowledgeBase()">éªŒè¯çŸ¥è¯†åº“</button>
        <div id="verifyResult" class="log"></div>
    </div>
    
    <div class="section">
        <h2>3. æµ‹è¯•æœç´¢åŠŸèƒ½</h2>
        <button onclick="testSearchFunction()">æµ‹è¯•æœç´¢</button>
        <div id="searchTestResult" class="log"></div>
    </div>

    <script type="module">
        import { KnowledgeService } from './src/services/knowledgeService.js';
        import { ChatEnhancementService } from './src/services/chatEnhancementService.js';
        
        // æµ‹è¯•çŸ¥è¯†æ¡ç›®æ•°æ®
        const testEntries = [
            {
                name: "å‡­è‡",
                keywords: ["å‡­è‡", "æ¤ç‰©", "æ°´ç”Ÿæ¤ç‰©", "è‡èœ"],
                explanation: "å‡­è‡æ˜¯æŒ‡è‡èœï¼Œä¸€ç§æ°´ç”Ÿæ¤ç‰©ã€‚è‡èœï¼ˆå­¦åï¼šNymphoides peltataï¼‰æ˜¯é¾™èƒ†ç§‘è‡èœå±çš„å¤šå¹´ç”Ÿæµ®å¶è‰æœ¬æ¤ç‰©ã€‚å¶ç‰‡è¿‘åœ†å½¢ï¼ŒåŸºéƒ¨å¿ƒå½¢ï¼Œæµ®åœ¨æ°´é¢ä¸Šã€‚èŠ±é»„è‰²ï¼ŒèŠ±æœŸ6-8æœˆã€‚å¸¸ç”Ÿé•¿åœ¨æ± å¡˜ã€æ¹–æ³Šç­‰é™æ°´ä¸­ã€‚åœ¨å¤è¯—è¯ä¸­å¸¸è¢«æåŠï¼Œå¦‚ã€Šè¯—ç»ã€‹ä¸­çš„'å‚å·®è‡èœï¼Œå·¦å³æµä¹‹'ã€‚"
            },
            {
                name: "è‡èœ",
                keywords: ["è‡èœ", "æ°´ç”Ÿæ¤ç‰©", "é»„èŠ±", "æµ®å¶", "è¯—ç»"],
                explanation: "è‡èœæ˜¯é¾™èƒ†ç§‘è‡èœå±å¤šå¹´ç”Ÿæµ®å¶è‰æœ¬æ¤ç‰©ï¼Œå­¦åNymphoides peltataã€‚å¶ç‰‡åœ†å½¢è‡³åµåœ†å½¢ï¼ŒåŸºéƒ¨å¿ƒå½¢ï¼Œç›´å¾„3-8å˜ç±³ï¼Œæµ®åœ¨æ°´é¢ã€‚èŠ±å† é»„è‰²ï¼Œç›´å¾„çº¦2å˜ç±³ï¼ŒèŠ±æœŸ6-8æœˆã€‚å¹¿æ³›åˆ†å¸ƒäºäºšæ´²ã€æ¬§æ´²çš„æ¸©å¸¦åœ°åŒºã€‚åœ¨ä¸­å›½å¤å…¸æ–‡å­¦ä¸­ç»å¸¸å‡ºç°ï¼Œã€Šè¯—ç»Â·å…³é›ã€‹ä¸­æœ‰'å‚å·®è‡èœï¼Œå·¦å³æµä¹‹'çš„åå¥ã€‚"
            },
            {
                name: "æ°´ç”Ÿæ¤ç‰©",
                keywords: ["æ°´ç”Ÿæ¤ç‰©", "æ°´è‰", "æ¹¿åœ°", "ç”Ÿæ€"],
                explanation: "æ°´ç”Ÿæ¤ç‰©æ˜¯æŒ‡èƒ½å¤Ÿåœ¨æ°´ä¸­æ­£å¸¸ç”Ÿæ´»çš„æ¤ç‰©ã€‚æ ¹æ®ç”Ÿæ´»æ–¹å¼å¯åˆ†ä¸ºæŒºæ°´æ¤ç‰©ã€æµ®å¶æ¤ç‰©ã€æ²‰æ°´æ¤ç‰©å’Œæ¼‚æµ®æ¤ç‰©å››å¤§ç±»ã€‚æ°´ç”Ÿæ¤ç‰©åœ¨æ°´ç”Ÿæ€ç³»ç»Ÿä¸­èµ·ç€é‡è¦ä½œç”¨ï¼Œèƒ½å¤Ÿå‡€åŒ–æ°´è´¨ã€æä¾›æ°§æ°”ã€ä¸ºæ°´ç”ŸåŠ¨ç‰©æä¾›æ –æ¯åœ°ã€‚å¸¸è§çš„æ°´ç”Ÿæ¤ç‰©æœ‰è·èŠ±ã€ç¡è²ã€è‡èœã€æ°´è‘«èŠ¦ç­‰ã€‚"
            }
        ];
        
        window.createTestEntries = async function() {
            try {
                const logDiv = document.getElementById('createResult');
                logDiv.textContent = 'å¼€å§‹åˆ›å»ºæµ‹è¯•çŸ¥è¯†æ¡ç›®...\n';
                
                // è·å–æˆ–åˆ›å»ºçŸ¥è¯†åº“
                let knowledgeBases = await KnowledgeService.getKnowledgeBases();
                let knowledgeBase;
                
                if (knowledgeBases.length === 0) {
                    // åˆ›å»ºæ–°çš„çŸ¥è¯†åº“
                    knowledgeBase = await KnowledgeService.createKnowledgeBase({
                        name: 'æµ‹è¯•çŸ¥è¯†åº“',
                        description: 'ç”¨äºæµ‹è¯•æœç´¢åŠŸèƒ½çš„çŸ¥è¯†åº“'
                    });
                    logDiv.textContent += `åˆ›å»ºæ–°çŸ¥è¯†åº“: ${knowledgeBase.name} (${knowledgeBase.id})\n`;
                } else {
                    knowledgeBase = knowledgeBases[0];
                    logDiv.textContent += `ä½¿ç”¨ç°æœ‰çŸ¥è¯†åº“: ${knowledgeBase.name} (${knowledgeBase.id})\n`;
                }
                
                // åˆ›å»ºçŸ¥è¯†æ¡ç›®
                for (const entryData of testEntries) {
                    try {
                        const entry = await KnowledgeService.createKnowledgeEntry(
                            knowledgeBase.id,
                            entryData.name,
                            entryData.explanation,
                            entryData.keywords
                        );
                        logDiv.textContent += `âœ… åˆ›å»ºæ¡ç›®: ${entryData.name}\n`;
                    } catch (error) {
                        logDiv.textContent += `âŒ åˆ›å»ºæ¡ç›®å¤±è´¥ ${entryData.name}: ${error.message}\n`;
                    }
                }
                
                logDiv.textContent += '\næµ‹è¯•çŸ¥è¯†æ¡ç›®åˆ›å»ºå®Œæˆï¼';
                console.log('æµ‹è¯•çŸ¥è¯†æ¡ç›®åˆ›å»ºå®Œæˆ');
                
                // è‡ªåŠ¨éªŒè¯çŸ¥è¯†åº“å†…å®¹
                await verifyKnowledgeBase();
                
                // è‡ªåŠ¨æµ‹è¯•æœç´¢åŠŸèƒ½
                await testSearchFunction();
                
            } catch (error) {
                const errorMsg = 'åˆ›å»ºæµ‹è¯•æ¡ç›®å¤±è´¥: ' + error.message;
                document.getElementById('createResult').textContent = errorMsg;
                console.error(errorMsg, error);
            }
        };
        
        window.verifyKnowledgeBase = async function() {
            try {
                const logDiv = document.getElementById('verifyResult');
                logDiv.textContent = 'å¼€å§‹éªŒè¯çŸ¥è¯†åº“å†…å®¹...\n';
                
                // è·å–æ‰€æœ‰çŸ¥è¯†åº“
                const knowledgeBases = await KnowledgeService.getKnowledgeBases();
                logDiv.textContent += `æ‰¾åˆ° ${knowledgeBases.length} ä¸ªçŸ¥è¯†åº“\n`;
                
                for (const kb of knowledgeBases) {
                    const entries = await KnowledgeService.getKnowledgeEntries(kb.id);
                    logDiv.textContent += `\nçŸ¥è¯†åº“: ${kb.name} (${kb.id})\n`;
                    logDiv.textContent += `æ¡ç›®æ•°é‡: ${entries.length}\n`;
                    
                    entries.forEach((entry, index) => {
                        logDiv.textContent += `  ${index + 1}. ${entry.name} - å…³é”®è¯: [${entry.keywords.join(', ')}]\n`;
                    });
                }
                
                console.log('çŸ¥è¯†åº“éªŒè¯å®Œæˆ', { knowledgeBases });
                
            } catch (error) {
                const errorMsg = 'éªŒè¯çŸ¥è¯†åº“å¤±è´¥: ' + error.message;
                document.getElementById('verifyResult').textContent = errorMsg;
                console.error(errorMsg, error);
            }
        };
        
        window.testSearchFunction = async function() {
            try {
                const logDiv = document.getElementById('searchTestResult');
                logDiv.textContent = 'å¼€å§‹æµ‹è¯•æœç´¢åŠŸèƒ½...\n';
                
                // è·å–ç¬¬ä¸€ä¸ªçŸ¥è¯†åº“
                const knowledgeBases = await KnowledgeService.getKnowledgeBases();
                if (knowledgeBases.length === 0) {
                    logDiv.textContent += 'âŒ æ²¡æœ‰æ‰¾åˆ°çŸ¥è¯†åº“\n';
                    return;
                }
                
                const knowledgeBase = knowledgeBases[0];
                logDiv.textContent += `ä½¿ç”¨çŸ¥è¯†åº“: ${knowledgeBase.name}\n\n`;
                
                // æµ‹è¯•ä¸åŒçš„æœç´¢å…³é”®è¯
                const testQueries = [
                    'å‡­è‡ æ˜¯ä»€ä¹ˆ',
                    'è‡èœ',
                    'æ°´ç”Ÿæ¤ç‰©',
                    'é»„èŠ±',
                    'è¯—ç»'
                ];
                
                for (const query of testQueries) {
                    logDiv.textContent += `æµ‹è¯•æŸ¥è¯¢: "${query}"\n`;
                    
                    // 1. æå–å…³é”®è¯
                    const keywords = ChatEnhancementService.extractKeywords(query);
                    logDiv.textContent += `  æå–å…³é”®è¯: [${keywords.join(', ')}]\n`;
                    
                    // 2. æœç´¢çŸ¥è¯†åº“
                    const searchResults = await KnowledgeService.searchKnowledgeEntries(knowledgeBase.id, keywords);
                    logDiv.textContent += `  æœç´¢ç»“æœ: ${searchResults.length} ä¸ªæ¡ç›®\n`;
                    
                    searchResults.forEach((entry, index) => {
                        logDiv.textContent += `    ${index + 1}. ${entry.name}\n`;
                    });
                    
                    // 3. æµ‹è¯•å®Œæ•´å¢å¼ºæµç¨‹
                    const enhancedContext = await ChatEnhancementService.enhanceChatContext(
                        query,
                        knowledgeBase.id
                    );
                    
                    const totalEntries = enhancedContext.knowledgeResults.reduce((sum, result) => sum + result.entries.length, 0);
                    logDiv.textContent += `  å¢å¼ºç»“æœ: ${totalEntries} ä¸ªæ¡ç›®\n\n`;
                }
                
                logDiv.textContent += 'æœç´¢åŠŸèƒ½æµ‹è¯•å®Œæˆï¼';
                console.log('æœç´¢åŠŸèƒ½æµ‹è¯•å®Œæˆ');
                
            } catch (error) {
                const errorMsg = 'æœç´¢åŠŸèƒ½æµ‹è¯•å¤±è´¥: ' + error.message;
                document.getElementById('searchTestResult').textContent = errorMsg;
                console.error(errorMsg, error);
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.addEventListener('load', () => {
            console.log('æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œè‡ªåŠ¨å¼€å§‹æµ‹è¯•...');
        
        // è‡ªåŠ¨å¼€å§‹æµ‹è¯•
        setTimeout(async () => {
          console.log('ğŸš€ å¼€å§‹è‡ªåŠ¨æµ‹è¯•æµç¨‹');
          await createTestEntries();
        }, 1000);
        });
    </script>
</body>
</html>